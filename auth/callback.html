<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Connecting...</title>
    <style>
        body { background: #0e0e10; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .box { background: #18181b; padding: 2rem; border-radius: 1rem; text-align: center; max-width: 400px; }
        .loader { border: 4px solid #333; border-top: 4px solid #9147ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { color: #eb4034; }
    </style>
</head>
<body>
    <div class="box">
        <div id="status-icon" class="loader"></div>
        <h2 id="status-text">Finalizing Connection...</h2>
        <p id="error-text" class="error"></p>
    </div>

    <script type="module">
        import { StorageService } from '../src/services/StorageService.js';
        import { TwitchAPI } from '../src/services/TwitchAPI.js';
        import { config } from '../src/config.js';

        async function handleCallback() {
            const statusText = document.getElementById('status-text');
            const errorText = document.getElementById('error-text');
            const statusIcon = document.getElementById('status-icon');

            try {
                // 1. Get tokens from URL hash
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                const state = params.get('state');
                const storedState = StorageService.get(StorageService.KEYS.OAUTH_STATE);

                if (!accessToken) throw new Error("No access token found in URL.");
                if (state !== storedState) throw new Error("Security mismatch (State). Please try again.");

                // 2. Fetch User Info
                const clientId = config.settings.TWITCH.CLIENT_ID;
                const api = new TwitchAPI(clientId, accessToken);
                const user = await api.fetchUserInfo();

                if (!user) throw new Error("Twitch didn't return user data.");

                // 3. Save everything
                StorageService.setAuthData(accessToken, user.login, user.id);
                localStorage.setItem('twitch_username', user.login); // For compatibility

                statusText.textContent = "Success! Redirecting...";
                setTimeout(() => window.location.href = '/index.html', 1000);

            } catch (err) {
                console.error(err);
                statusIcon.style.display = 'none';
                statusText.textContent = "Connection Failed";
                errorText.textContent = err.message;
            }
        }

        handleCallback();
    </script>
</body>
</html>
